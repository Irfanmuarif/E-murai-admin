<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel E-murai</title>
    
    <!-- Font Inter (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --fb-blue: #1877f2;
            --bg-body: #f0f2f5;
            --surface: #ffffff;
            --text-main: #050505;
            --text-muted: #65676b;
            --border-color: #ced0d4;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-float: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            padding-bottom: 100px;
            margin: 0;
        }

        /* --- LOGIN OVERLAY --- */
        #loginSection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(240, 242, 245, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .login-card {
            background: var(--surface);
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-float);
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .login-icon {
            font-size: 3rem;
            color: #6366f1;
            margin-bottom: 20px;
            display: inline-block;
            padding: 20px;
            background: #e0e7ff;
            border-radius: 50%;
        }

        /* --- MAIN APP CONTAINER --- */
        /* Secara default sembunyikan sampai login sukses */
        #appContainer {
            display: none; 
        }

        /* --- NAVBAR --- */
        .navbar {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-bottom:1px solid var(--border-color);
            padding-top: 0.8rem;
            padding-bottom: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--text-main) !important;
            font-size:1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .navbar-brand i {
            color: #6366f1;
        }

        /* --- CONTENT WRAPPER --- */
        .content-wrapper {
            background: transparent;
            box-shadow: none;
            padding: 0;
            margin-top: 20px;
        }

        /* --- BOTTOM NAV (TEXT & ICON) --- */
        .bottom-nav-wrapper {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 8px 10px;
            border-radius: 50px;
            box-shadow: var(--shadow-float);
            display: flex;
            width: 95%;
            max-width: 450px;
            border:1px solid rgba(0,0,0,0.05);
        }
        
        .nav-tabs.bottom-tabs {
            border: none;
            background: transparent;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0;
            margin: 0;
            gap: 2px;
        }

        .nav-tabs.bottom-tabs .nav-item {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .nav-tabs.bottom-tabs .nav-link {
            color: var(--text-muted);
            font-weight: 600;
            border: none;
            border-radius: 20px;
            padding: 0;
            height: 55px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            width: 100%;
            text-align: center;
        }
        .nav-tabs.bottom-tabs .nav-link i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
        .nav-tabs.bottom-tabs .nav-link span.tab-text {
            font-size: 0.6rem;
            line-height: 1;
            text-transform: capitalize;
        }
        
        .nav-tabs.bottom-tabs .nav-link.active {
            color: white;
            background: var(--fb-blue);
            box-shadow: none;
        }
        .nav-tabs.bottom-tabs .nav-link:hover:not(.active) {
            background-color: rgba(0,0,0,0.05);
            color: var(--text-main);
        }

        /* --- BUTTONS --- */
        .btn-primary-custom {
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
            color: white;
        }
        .btn-primary-custom:active {
            transform: translateY(1px);
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* --- LOADER --- */
        .loader {
            background-color: rgba(255,255,255,0.6);
            backdrop-filter: blur(4px);
        }

        /* --- ALERT --- */
        .alert {
            border: none;
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-md);
        }
        
        /* --- UANG KAS CARDS --- */
        .uangkas-control-bar {
            background: var(--surface);
            padding:16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border:1px solid var(--border-color);
        }
        .uangkas-balance-display {
            text-align: right;
        }
        .uangkas-balance-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .uangkas-balance-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .uangkas-period-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border:1px solid var(--border-color);
        }
        .uangkas-period-header {
            background-color: #f9fafb;
            padding: 12px 16px;
            font-weight: 600;
            color: var(--text-main);
            border-bottom:1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; 
            transition: background 0.2s;
        }
        .uangkas-period-header:hover {
            background-color: #f3f4f6;
        }
        .uangkas-period-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }
        .uangkas-period-icon {
            width: 28px;
            height: 28px;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        .uangkas-period-saldo {
            font-weight: 700;
            color: var(--success-color);
            font-size: 0.85rem;
            background: #ecfdf5;
            padding: 2px 8px;
            border-radius: 20px;
        }
        .chevron-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-muted);
        }
        .uangkas-period-header:not(.collapsed) .chevron-icon {
            transform: rotate(180deg);
        }

        /* --- TABLES & STICKY COLS --- */
        .table-responsive {
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        .table {
            margin-bottom: 0;
            color: var(--text-main);
            font-size: 0.9rem;
        }
        .table thead th {
            background-color: #f9fafb;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            border-bottom:1px solid var(--border-color);
            white-space: nowrap;
        }
        .table tbody tr {
            transition: background 0.1s;
        }
        .table tbody tr:hover {
            background-color: #f9fafb;
        }
        .table td {
            border-bottom:1px solid #f3f4f6;
            vertical-align: middle;
        }
        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Sticky First Column Logic */
        .table th:first-child,
        .table td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: var(--surface); 
            border-right:1px solid #f3f4f6;
        }
        .table thead th:first-child {
            z-index: 20;
            background-color: #f9fafb; 
            border-right:1px solid #e5e7eb;
        }
        
        .action-cell .btn {
            border-radius: 6px;
            padding: 2px 6px; 
            font-size: 0.75rem;
        }

        /* --- MODAL --- */
        .modal-content {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            border-bottom:1px solid var(--border-color);
            padding: 20px 24px;
        }
        .modal-title {
            font-weight: 700;
            color: var(--text-main);
        }
        .modal-body {
            padding: 24px;
        }
        .modal-footer {
            border-top:1px solid var(--border-color);
            padding: 16px 24px;
            background: #f9fafb;
            border-bottom-left-radius: var(--radius-lg);
            border-bottom-right-radius: var(--radius-lg);
        }
        .form-control, .form-select {
            border-radius: 8px;
            border:1px solid #d1d5db;
            padding: 10px 14px;
            font-size: 0.95rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .form-label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 6px;
            color: var(--text-main);
        }

        /* --- PENGUMUMAN CARD --- */
        .pengumuman-item {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: var(--shadow-sm);
        }
        .pengumuman-title {
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        .pengumuman-body {
            color: var(--text-main);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .pengumuman-body.truncated {
            display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-muted);
        }
        .pengumuman-btn-toggle {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--fb-blue);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }
        .pengumuman-btn-toggle:hover {
            text-decoration: underline;
        }

        /* --- ICONS & CLICKABLE --- */
        .clickable-icon {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .clickable-icon:active {
            transform: scale(0.9);
        }

        /* --- JADWAL RONDA COMPACT HEADER (2 BARIS) --- */
        .compact-table thead th {
            height: 60px; 
            max-width: 70px; 
            white-space: normal; 
            vertical-align: middle;
            padding: 5px !important;
            line-height: 1.2;
        }
        .compact-table thead th:first-child {
            max-width: 120px; 
            width: auto;
        }

        /* --- MOBILE OPTIMIZATIONS (< 768px) --- */
        @media (max-width: 768px) {
            body {
                padding-bottom: 100px; 
            }
            .content-wrapper {
                margin-top: 10px;
                padding: 0 8px; 
            }

            /* Bottom Nav Mobile Tweak */
            .bottom-nav-wrapper {
                width: 96%;
                padding: 6px;
            }
            .nav-tabs.bottom-tabs .nav-link {
                height: 45px; 
            }
            .nav-tabs.bottom-tabs .nav-link i {
                font-size: 1rem;
                margin-bottom: 0;
            }
            .nav-tabs.bottom-tabs .nav-link span.tab-text {
                font-size: 0.55rem; 
                font-weight: 600;
            }

            /* Control Bar Stacking */
            .uangkas-control-bar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
                text-align: center;
                padding: 12px;
            }
            .uangkas-balance-display {
                text-align: center;
                background: white;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid #e5e7eb;
            }
            .uangkas-balance-amount {
                font-size: 1.1rem;
            }
            
            /* Card Header Mobile */
            .uangkas-period-header {
                flex-direction: row; 
                padding: 10px 12px;
            }
            .uangkas-period-title {
                font-size: 0.85rem;
            }
            .uangkas-period-saldo {
                font-size: 0.75rem;
                padding: 2px 8px;
                display: none; 
            }
            .uangkas-period-header:hover .uangkas-period-saldo {
                display: block;
                position: absolute;
                top: -10px;
                right: 10px;
                background: #10b981;
                color: white;
                z-index: 5;
                border-radius: 4px;
                padding: 4px;
            }

            /* --- UANG KAS LARGER FONT ON MOBILE --- */
            .uangkas-period-card .table {
                font-size: 0.85rem !important; 
                line-height: 1.4 !important;
            }

            /* Table General Compact */
            .table {
                font-size: 0.75rem !important;
            }
            .table tbody tr {
                line-height: 1.3 !important;
            }
            .table th, .table td {
                padding: 4px 8px !important; 
            }
            
            /* Hide text in small buttons, keep icons */
            .btn-sm span {
                display: none;
            }
            .btn-sm i {
                margin: 0;
                font-size: 1rem;
            }
            
            /* Adjust sticky column width slightly */
            .table th:first-child, .table td:first-child {
                min-width: 90px;
            }
        }
    </style>
</head>
<body>

    <!-- LOGIN OVERLAY -->
    <div id="loginSection">
        <div class="login-card">
            <div class="login-icon">
                <i class="bi bi-lock-fill"></i>
            </div>
            <h3 class="fw-bold mb-1">Admin Login</h3>
            <p class="text-muted mb-4">Masukkan password untuk akses data.</p>
            
            <div class="mb-3 text-start">
                <label for="adminPassword" class="form-label fw-semibold">Password</label>
                <input type="password" class="form-control form-control-lg" id="adminPassword" placeholder="Masukkan password...">
            </div>
            
            <button onclick="checkLogin()" class="btn btn-primary-custom w-100 py-2">
                Masuk Dashboard
            </button>
            <div id="loginError" class="text-danger mt-3" style="display:none;">Password salah!</div>
        </div>
    </div>

    <!-- WRAPPER SELURUH APLIKASI (Disembunyikan sampai login) -->
    <div id="appContainer">

        <!-- Loader -->
        <div id="loader" class="loader" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Navbar -->
        <nav class="navbar navbar-light">
            <div class="container-fluid px-3 px-md-5">
                <span class="navbar-brand">
                    <i class="bi bi-grid-1x2-fill"></i>
                    <span>Admin Panel E-murai</span>
                </span>
                <div class="d-flex align-items-center">
                    <!-- Tombol Logout (Kecil) -->
                    <button onclick="logout()" class="btn btn-sm btn-outline-secondary me-2" title="Logout">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Alert Container -->
        <div class="alert-container container px-3 mt-3" id="alertContainer"></div>

        <!-- Main Content -->
        <main class="container">
            <div class="content-wrapper">
                <!-- Konten Tab -->
                <div class="tab-content" id="sheetTabContent">
                    
                    <!-- Header Tombol Tambah (Standard) -->
                    <div class="d-flex justify-content-between align-items-center mb-4 px-1" id="actionHeader">
                        <h2 class="h4 fw-bold text-dark">Data Tabel</h2>
                        <button class="btn btn-primary-custom btn-sm" onclick="openCreateModal()">
                            <i class="bi bi-plus-lg me-1"></i> Tambah Data
                        </button>
                    </div>

                    <!-- Wadah untuk Tabel Biasa -->
                    <div class="table-responsive d-none p-0" id="standardTableContainer" style="background: white; border-radius: 12px; box-shadow: var(--shadow-sm);">
                        <table class="table table-hover align-middle" id="dataTable">
                            <thead>
                                <!-- Header akan di-generate oleh JavaScript -->
                            </thead>
                            <tbody>
                                <!-- Baris data akan di-generate oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Wadah untuk Uang Kas (Grouped Tables) -->
                    <div id="uangKasContainer"></div>

                    <!-- Wadah untuk Pengumuman (List Cards) -->
                    <div id="pengumumanContainer"></div>

                </div>
            </div>
        </main>

        <!-- BOTTOM NAV (TEXT & ICON) -->
        <div class="bottom-nav-wrapper">
            <ul class="nav nav-tabs bottom-tabs" id="sheetTabs" role="tablist">
                <!-- Tab akan di-generate oleh JavaScript -->
            </ul>
        </div>

        <!-- Modal Create/Update -->
        <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="formModalLabel">Tambah Data Baru</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="dataForm">
                        <div class="modal-body" id="formModalBody">
                            <!-- Input form akan di-generate oleh JavaScript -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light fw-semibold" data-bs-dismiss="modal" style="border: 1px solid #d1d5db;">Batal</button>
                            <button type="submit" class="btn btn-primary-custom">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Delete Confirmation -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-danger" id="deleteModalLabel">Hapus Data?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-secondary">Data yang dihapus tidak dapat dikembalikan.</p>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-light w-100 fw-semibold" data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-danger w-100" id="confirmDeleteBtn">
                            <i class="bi bi-trash"></i> Hapus
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End App Container -->

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIG LOGIN ---
        // GANTI PASSWORD DI SINI
        const ADMIN_PASSWORD = "admin123";
        
        // Cek apakah user sudah login sebelumnya
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedin = localStorage.getItem('isAdminLogged');
            if (isLoggedin === 'true') {
                showApp();
            } else {
                // Biarkan tampilan login
                document.getElementById('adminPassword').focus();
            }
        });

        function checkLogin() {
            const inputPass = document.getElementById('adminPassword').value;
            const errorMsg = document.getElementById('loginError');

            if (inputPass === ADMIN_PASSWORD) {
                // Password Benar
                localStorage.setItem('isAdminLogged', 'true'); // Ingat user
                showApp();
            } else {
                // Password Salah
                errorMsg.style.display = 'block';
                document.getElementById('adminPassword').classList.add('is-invalid');
                
                // Shake effect
                const card = document.querySelector('.login-card');
                card.style.transform = 'translateX(10px)';
                setTimeout(() => card.style.transform = 'translateX(-10px)', 100);
                setTimeout(() => card.style.transform = 'translateX(0)', 200);
            }
        }

        function showApp() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            // Inisialisasi App setelah login
            initializeApp();
        }

        function logout() {
            localStorage.removeItem('isAdminLogged');
            location.reload();
        }

        // --- KONFIGURASI APP UTAMA ---
        function initializeApp() {
            initializeTabs();
            loadData(SHEETS[0]);
            document.getElementById('dataForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        }

        const SHEETS = ['PENGUMUMAN', 'UANG KAS', 'IURAN BULANAN', 'JADWAL RONDA']; 
        const API_URL = 'https://script.google.com/macros/s/AKfycbygmCF0fjpkSiBDPz4kNNtNjfxR0CZu_qcF19V5NTxegnx0Os3-UfpPh4PV1KUsUBA4/exec';
        
        const BOOLEAN_SHEETS = ['IURAN BULANAN', 'JADWAL RONDA'];

        let currentHeaders = [];
        let currentAction = 'create';
        let currentRowNumber = null;
        let currentSheet = SHEETS[0];
        let tableData = []; 

        function initializeTabs() {
            const tabList = document.getElementById('sheetTabs');
            SHEETS.forEach((sheetName, index) => {
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.setAttribute('role', 'presentation');
                const button = document.createElement('button');
                button.className = `nav-link ${index === 0 ? 'active' : ''}`;
                button.setAttribute('type', 'button');
                button.setAttribute('role', 'tab');
                button.setAttribute('title', sheetName);
                let iconClass = 'bi-grid';
                if (sheetName === 'PENGUMUMAN') iconClass = 'bi-megaphone-fill';
                else if (sheetName === 'UANG KAS') iconClass = 'bi-wallet2';
                else if (sheetName === 'IURAN BULANAN') iconClass = 'bi-calendar-check';
                else if (sheetName === 'JADWAL RONDA') iconClass = 'bi-shield-check';

                button.innerHTML = `
                    <div><i class="bi ${iconClass}"></i></div>
                    <span class="tab-text">${sheetName}</span>
                `;
                button.onclick = () => switchSheet(sheetName, button);
                li.appendChild(button);
                tabList.appendChild(li);
            });
        }

        function switchSheet(sheetName, buttonElement) {
            document.querySelectorAll('#sheetTabs .nav-link').forEach(btn => btn.classList.remove('active'));
            buttonElement.classList.add('active');
            currentSheet = sheetName;
            loadData(currentSheet);
        }

        function formatDateDisplay(value) {
            if (!value) return '';
            if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return value;
            }
            let dateObj = (typeof value === 'string') ? new Date(value) : value;
            if (value instanceof Date) dateObj = value;
            else return value; 
            if (isNaN(dateObj.getTime())) return value; 
            return dateObj.toLocaleDateString('en-CA'); 
        }

        function formatDateForInput(value) {
            if (!value) return '';
            let d;
            if (typeof value === 'string') {
                d = new Date(value);
            } else if (value instanceof Date) {
                d = value;
            } else {
                return '';
            }
            if (isNaN(d.getTime())) return '';
            const date = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
            return date.toISOString().split('T')[0];
        }

        async function loadData(sheetName) {
            showLoader(true);
            try {
                const response = await fetch(`${API_URL}?sheet=${sheetName}`);
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                currentHeaders = result.headers;
                tableData = result.rows;
                renderTable(result.headers, result.rows);
            } catch (error) {
                showAlert('Gagal memuat data: ' + error.message, 'danger');
                document.querySelector('#dataTable thead').innerHTML = '';
                document.querySelector('#dataTable tbody').innerHTML = '';
                document.getElementById('uangKasContainer').innerHTML = '';
                document.getElementById('pengumumanContainer').innerHTML = '';
            } finally {
                showLoader(false);
            }
        }

        function renderTable(headers, rows) {
            const standardContainer = document.getElementById('standardTableContainer');
            const uangKasContainer = document.getElementById('uangKasContainer');
            const pengumumanContainer = document.getElementById('pengumumanContainer');
            const actionHeader = document.getElementById('actionHeader');
            
            standardContainer.classList.add('d-none');
            standardContainer.classList.remove('d-block');
            uangKasContainer.innerHTML = '';
            pengumumanContainer.innerHTML = '';
            actionHeader.classList.add('d-none');
            
            if (currentSheet === 'PENGUMUMAN') {
                renderPengumumanPartial(rows, pengumumanContainer);
                return; 
            }
            
            if (currentSheet === 'UANG KAS') {
                renderUangKasGrouped(headers, rows, uangKasContainer);
                return;
            }

            actionHeader.classList.remove('d-none');
            standardContainer.classList.remove('d-none');
            standardContainer.classList.add('d-block');
            fillStandardTable(document.getElementById('dataTable'), headers, rows);
        }

        function fillStandardTable(tableElement, headers, rows) {
            const tableHead = tableElement.querySelector('thead');
            const tableBody = tableElement.querySelector('tbody');
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            if (headers.length === 0) return renderEmptyState(tableBody);

            let workingRows = [...rows];
            let dataKeys = headers; 
            let displayHeaders = headers; 

            if (currentSheet === 'JADWAL RONDA') {
                const renamedHeaders = headers.map(h => String(h).toLowerCase() === "terakhir ronda" ? "Hari" : h);
                displayHeaders = renamedHeaders.map(h => (typeof h !== 'string') ? h : (/^\d{2}-\w{3}-\d{4}$/.test(h) ? h.substring(0, 6) : h));
                const lastRondaIndex = renamedHeaders.findIndex(h => String(h).toLowerCase() === "hari"); 
                if (lastRondaIndex !== -1) {
                    const originalHeaderKey = headers[lastRondaIndex]; 
                    workingRows.sort((a, b) => (parseInt(b[originalHeaderKey]) || 0) - (parseInt(a[originalHeaderKey]) || 0));
                }
            }

            const headerRow = document.createElement('tr');
            displayHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            const thAction = document.createElement('th');
            thAction.textContent = 'Aksi';
            thAction.className = 'text-end pe-3';
            headerRow.appendChild(thAction);
            tableHead.appendChild(headerRow);

            workingRows.forEach(row => {
                const tr = document.createElement('tr');
                dataKeys.forEach((originalKey, idx) => {
                    const td = document.createElement('td');
                    const cellValue = row[originalKey];
                    
                    if (BOOLEAN_SHEETS.includes(currentSheet) && typeof cellValue === 'boolean') {
                        td.className = 'text-center';
                        const icon = document.createElement('i');
                        icon.className = 'clickable-icon bi ' + (cellValue ? 'bi-check-circle-fill text-success fs-5' : 'bi-circle text-muted fs-5');
                        icon.title = cellValue ? 'Selesai. Klik untuk ubah.' : 'Belum Selesai. Klik untuk ubah.';
                        icon.onclick = () => toggleBoolean(row._row, originalKey, icon);
                        td.appendChild(icon);
                    } else {
                        td.textContent = cellValue || '-';
                    }
                    tr.appendChild(td);
                });
                
                const tdAction = document.createElement('td');
                tdAction.className = 'text-end pe-3';
                let actionButtonsHTML = '';
                if (BOOLEAN_SHEETS.includes(currentSheet)) {
                    actionButtonsHTML = `<button class="btn btn-danger btn-sm rounded-circle" style="width:32px; height:32px; padding:0; display:inline-flex; align-items:center; justify-content:center;" onclick="openDeleteModal(${row._row})"><i class="bi bi-trash"></i></button>`;
                } else {
                    actionButtonsHTML = `
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-warning btn-sm" onclick="openUpdateModal(${row._row}, ${JSON.stringify(row).replace(/"/g, '&quot;')})"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-outline-danger btn-sm" onclick="openDeleteModal(${row._row})"><i class="bi bi-trash-fill"></i></button>
                        </div>
                    `;
                }
                tdAction.innerHTML = actionButtonsHTML;
                tr.appendChild(tdAction);
                tableBody.appendChild(tr);
            });
            
            if (currentSheet === 'JADWAL RONDA' && window.innerWidth <= 768) {
                setTimeout(() => {
                    const container = tableElement.closest('.table-responsive');
                    if (container && container.scrollWidth > container.clientWidth) container.scrollLeft = container.scrollWidth;
                }, 100);
            }
        }

        function renderPengumumanPartial(rows, container) {
            if (rows.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">Tidak ada pengumuman.</div>';
                return;
            }

            rows.forEach(row => {
                const card = document.createElement('div');
                card.className = 'pengumuman-item';
                const judulKey = currentHeaders[2]; // Kolom ke-3 (Index 2)
                const isiKey = currentHeaders[3];    // Kolom ke-4 (Index 3)
                const dateKey = currentHeaders[1];   // Kolom ke-2 (Index 1)

                const judul = (judulKey) ? (row[judulKey] || "Tanpa Judul") : "Format Data Salah (Judul)";
                const isi = (isiKey) ? (row[isiKey] || "") : "";
                let dateStr = "";
                if(dateKey && row[dateKey]) dateStr = formatDateDisplay(row[dateKey]);

                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="pengumuman-title">${judul}</div>
                        <small class="text-muted" style="font-size:0.8rem;">${dateStr}</small>
                    </div>
                    <div class="pengumuman-body truncated" id="pengumuman-body-${row._row}">${isi}</div>
                    <div class="text-end">
                        <button class="pengumuman-btn-toggle" onclick="togglePengumuman(${row._row}, this)">Baca Selengkapnya...</button>
                    </div>
                    <div class="mt-2 pt-2 border-top d-flex justify-content-end gap-2">
                        <button class="btn btn-sm btn-outline-warning" onclick="openUpdateModal(${row._row}, ${JSON.stringify(row).replace(/"/g, '&quot;')})"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal(${row._row})"><i class="bi bi-trash-fill"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function togglePengumuman(rowId, btnElement) {
            const bodyEl = document.getElementById(`pengumuman-body-${rowId}`);
            if (bodyEl.classList.contains('truncated')) {
                bodyEl.classList.remove('truncated');
                btnElement.textContent = "Tutup";
            } else {
                bodyEl.classList.add('truncated');
                btnElement.textContent = "Baca Selengkapnya...";
            }
        }

        function renderUangKasGrouped(headers, rows, container) {
            let grandTotal = 0;
            const keyMasuk = headers.find(h => h.toLowerCase().includes('pemasukkan')) || headers[4];
            const keyKeluar = headers.find(h => h.toLowerCase().includes('pengeluaran')) || headers[5];

            rows.forEach(r => grandTotal += ((parseFloat(r[keyMasuk]) || 0) - (parseFloat(r[keyKeluar]) || 0)));

            const controlBar = document.createElement('div');
            controlBar.className = 'uangkas-control-bar';
            
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary-custom';
            addBtn.innerHTML = '<i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Tambah Transaksi</span>';
            addBtn.onclick = openCreateModal;
            
            const totalDiv = document.createElement('div');
            totalDiv.className = 'uangkas-balance-display';
            totalDiv.innerHTML = `
                <div class="uangkas-balance-label">Saldo Kas Saat Ini</div>
                <div class="uangkas-balance-amount">Rp ${grandTotal.toLocaleString('id-ID')}</div>
            `;

            controlBar.appendChild(addBtn);
            controlBar.appendChild(totalDiv);
            container.appendChild(controlBar);

            if (rows.length === 0) {
                container.innerHTML += '<div class="text-center py-5"><div class="mb-3 text-muted"><i class="bi bi-wallet2" style="font-size: 3rem; opacity: 0.3;"></i></div><p class="text-muted">Belum ada data kas.</p></div>';
                return;
            }

            const keyPeriode = headers.find(h => h.toLowerCase() === 'periode') || headers[1];
            const keyTanggal = headers.find(h => h.toLowerCase() === 'tanggal') || headers[2];
            const keyKet = headers.find(h => h.toLowerCase().includes('keterangan')) || headers[3];

            const formatPeriodeDisplay = (rawVal) => {
                if (!rawVal) return 'Tanpa Periode';
                if (typeof rawVal === 'string' && !rawVal.includes('T') && isNaN(new Date(rawVal).getTime())) return rawVal;
                const dateObj = new Date(rawVal);
                if (isNaN(dateObj.getTime())) return String(rawVal);
                return dateObj.toLocaleDateString('id-ID', { month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' });
            };

            const groups = rows.reduce((acc, row) => {
                const rawPeriode = row[keyPeriode];
                const displayPeriode = formatPeriodeDisplay(rawPeriode);
                const refDate = row[keyTanggal] ? new Date(row[keyTanggal]) : new Date(0);
                if (!acc[displayPeriode]) { acc[displayPeriode] = { rows: [], sortDate: refDate }; }
                acc[displayPeriode].rows.push(row);
                if (refDate > acc[displayPeriode].sortDate) acc[displayPeriode].sortDate = refDate;
                return acc;
            }, {});

            const sortedPeriodKeys = Object.keys(groups).sort((a, b) => groups[b].sortDate - groups[a].sortDate);

            sortedPeriodKeys.forEach((periode, index) => {
                const groupData = groups[periode];
                const groupRows = groupData.rows;
                let totalMasuk = 0, totalKeluar = 0;
                
                groupRows.forEach(r => { totalMasuk += (parseFloat(r[keyMasuk]) || 0); totalKeluar += (parseFloat(r[keyKeluar]) || 0); });
                const saldo = totalMasuk - totalKeluar;

                const collapseId = `collapse-${periode.replace(/\s+/g, '-')}`;
                const isTopCard = (index === 0);
                const headerCollapsedClass = isTopCard ? '' : 'collapsed';
                const bodyShowClass = isTopCard ? 'show' : '';
                const ariaExpanded = isTopCard ? 'true' : 'false';

                const card = document.createElement('div');
                card.className = 'uangkas-period-card';

                const cardHeader = document.createElement('div');
                cardHeader.className = `uangkas-period-header ${headerCollapsedClass}`;
                cardHeader.setAttribute('data-bs-toggle', 'collapse');
                cardHeader.setAttribute('data-bs-target', `#${collapseId}`);
                cardHeader.setAttribute('aria-expanded', ariaExpanded);
                cardHeader.setAttribute('aria-controls', collapseId);
                cardHeader.innerHTML = `
                    <div class="uangkas-period-title"><div class="uangkas-period-icon"><i class="bi bi-calendar-event"></i></div><span>${periode}</span></div>
                    <div class="d-flex align-items-center">
                        <div class="uangkas-period-saldo me-3">Saldo: Rp ${saldo.toLocaleString('id-ID')}</div>
                        <i class="bi bi-chevron-down chevron-icon"></i>
                    </div>
                `;

                const collapseDiv = document.createElement('div');
                collapseDiv.id = collapseId;
                collapseDiv.className = `collapse ${bodyShowClass}`;
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-responsive'; 
                const table = document.createElement('table');
                table.className = 'table table-hover align-middle';
                const thead = document.createElement('thead');
                thead.innerHTML = `<tr><th>Tanggal</th><th style="min-width: 200px;">Keterangan</th><th class="text-end">Masuk</th><th class="text-end">Keluar</th><th class="text-end">Aksi</th></tr>`;
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                
                groupRows.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="fw-bold text-secondary">${formatDateDisplay(row[keyTanggal])}</td>
                        <td>${row[keyKet] || ''}</td>
                        <td class="text-end text-success fw-semibold">${row[keyMasuk] ? parseInt(row[keyMasuk]).toLocaleString('id-ID') : '-'}</td>
                        <td class="text-end text-danger fw-semibold">${row[keyKeluar] ? parseInt(row[keyKeluar]).toLocaleString('id-ID') : '-'}</td>
                        <td class="text-end pe-3">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-warning" onclick="openUpdateModal(${row._row}, ${JSON.stringify(row).replace(/"/g, '&quot;')})"><i class="bi bi-pencil-fill"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal(${row._row})"><i class="bi bi-trash-fill"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                tableWrapper.appendChild(table);
                collapseDiv.appendChild(tableWrapper);
                card.appendChild(cardHeader);
                card.appendChild(collapseDiv);
                container.appendChild(card);
            });
        }

        function renderEmptyState(tbody) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = "100%";
            td.className = "text-center text-muted py-4";
            td.textContent = "Tidak ada data.";
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
        
        // --- MODAL HANDLERS ---
        function openCreateModal() {
            currentAction = 'create';
            document.getElementById('formModalLabel').innerText = `Tambah Data Baru ke ${currentSheet}`;
            if (currentSheet === 'IURAN BULANAN' || currentSheet === 'JADWAL RONDA') {
                generateSimplifiedFormFields();
            } else if (currentSheet === 'UANG KAS') {
                generateUangKasFormFields(); 
            } else {
                generateFormFields();
            }
            new bootstrap.Modal(document.getElementById('formModal')).show();
        }

        function openUpdateModal(rowNumber, rowData) {
            currentAction = 'update';
            currentRowNumber = rowNumber;
            document.getElementById('formModalLabel').innerText = `Edit Data di ${currentSheet}`;
            if (currentSheet === 'UANG KAS') {
                generateUangKasFormFields(rowData); 
            } else if (currentSheet === 'IURAN BULANAN' || currentSheet === 'JADWAL RONDA') {
                generateSimplifiedFormFields(rowData);
            } else {
                generateFormFields(rowData);
            }
            new bootstrap.Modal(document.getElementById('formModal')).show();
        }
        
        function openDeleteModal(rowNumber) {
            currentRowNumber = rowNumber;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // --- FORM GENERATORS ---
        function generateFormFields(data = {}) {
            const formBody = document.getElementById('formModalBody');
            formBody.innerHTML = '';
            if (currentHeaders.length === 0) {
                formBody.innerHTML = '<p class="text-muted">Tidak ada kolom untuk diisi.</p>';
                return;
            }
            currentHeaders.forEach(header => {
                if (String(header).trim().toUpperCase() === 'ID') {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = `input-${header}`;
                    input.name = header;
                    input.value = (data[header] !== undefined && data[header] !== null) ? data[header] : '';
                    formBody.appendChild(input);
                    return;
                }
                let isDateColumn = header.toLowerCase().includes('tanggal');
                let inputType = isDateColumn ? 'date' : 'text';
                let inputValue = (data[header] !== undefined && data[header] !== null) ? data[header] : '';
                if (isDateColumn) inputValue = formatDateForInput(inputValue);

                const formGroup = document.createElement('div');
                formGroup.className = 'mb-3';
                const label = document.createElement('label');
                label.htmlFor = `input-${header}`;
                label.className = 'form-label';
                label.textContent = header;
                
                if (typeof data[header] === 'boolean') {
                    formGroup.className = 'mb-3 form-check';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'form-check-input';
                    input.id = `input-${header}`;
                    input.name = header;
                    input.checked = data[header];
                    formGroup.appendChild(input);
                    formGroup.appendChild(label);
                } else {
                    const input = document.createElement('input');
                    input.type = inputType;
                    input.className = 'form-control';
                    input.id = `input-${header}`;
                    input.name = header;
                    input.value = inputValue;
                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                }
                formBody.appendChild(formGroup);
            });
        }

        function generateSimplifiedFormFields(data = null) {
            const formBody = document.getElementById('formModalBody');
            formBody.innerHTML = '';
            if (currentHeaders.length === 0) {
                formBody.innerHTML = '<p class="text-muted">Tidak ada kolom untuk diisi.</p>';
                return;
            }
            const header = currentHeaders[0];
            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';
            const label = document.createElement('label');
            label.htmlFor = `input-${header}`;
            label.className = 'form-label';
            label.textContent = header;
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.id = `input-${header}`;
            input.name = header;
            input.value = (data) ? data[header] : '';
            input.required = true;
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            formBody.appendChild(formGroup);

            const infoDiv = document.createElement('div');
            infoDiv.className = 'alert alert-info bg-light border-0 text-secondary';
            infoDiv.innerHTML = `<i class="bi bi-info-circle me-1"></i> Kolom lainnya akan otomatis diisi.`;
            formBody.appendChild(infoDiv);
        }

        function generateUangKasFormFields(data = null) {
            const formBody = document.getElementById('formModalBody');
            formBody.innerHTML = '';
            if (currentHeaders.length === 0) {
                formBody.innerHTML = '<p class="text-muted">Tidak ada kolom untuk diisi.</p>';
                return;
            }
            let initialDate = new Date(), initialKet = '', initialJenis = 'pemasukkan', initialJumlah = '';
            if (data) {
                const keyTanggal = currentHeaders.find(h => h.toLowerCase() === 'tanggal');
                const keyKet = currentHeaders.find(h => h.toLowerCase().includes('keterangan'));
                const keyMasuk = currentHeaders.find(h => h.toLowerCase().includes('pemasukkan'));
                const keyKeluar = currentHeaders.find(h => h.toLowerCase().includes('pengeluaran'));
                if (data[keyTanggal]) initialDate = new Date(data[keyTanggal]);
                if (data[keyKet]) initialKet = data[keyKet];
                const valMasuk = (data[keyMasuk] !== undefined && data[keyMasuk] !== null) ? parseFloat(data[keyMasuk]) : 0;
                const valKeluar = (data[keyKeluar] !== undefined && data[keyKeluar] !== null) ? parseFloat(data[keyKeluar]) : 0;
                if (valMasuk > 0) { initialJenis = 'pemasukkan'; initialJumlah = valMasuk; } 
                else if (valKeluar > 0) { initialJenis = 'pengeluaran'; initialJumlah = valKeluar; }
            }

            const formattedDate = `${initialDate.getFullYear()}-${String(initialDate.getMonth() + 1).padStart(2, '0')}-${String(initialDate.getDate()).padStart(2, '0')}`;

            const dateGroup = document.createElement('div');
            dateGroup.className = 'mb-3';
            dateGroup.innerHTML = `<label for='input-tanggal' class='form-label'>Tanggal Transaksi</label><input type='date' class='form-control' id='input-tanggal' name='tanggal' value='${formattedDate}' required>`;
            formBody.appendChild(dateGroup);

            const descHeader = currentHeaders.find(h => h.toLowerCase() === 'keterangan' || h.toLowerCase() === 'deskripsi') || 'Keterangan';
            const descGroup = document.createElement('div');
            descGroup.className = 'mb-3';
            descGroup.innerHTML = `<label for='input-keterangan' class='form-label'>${descHeader}</label><input type='text' class='form-control' id='input-keterangan' name='keterangan' value='${initialKet}' placeholder="Contoh: Iuran Kebersihan" required>`;
            formBody.appendChild(descGroup);

            const typeGroup = document.createElement('div');
            typeGroup.className = 'mb-3';
            const typeSelect = document.createElement('select');
            typeSelect.className = 'form-select';
            typeSelect.id = 'input-jenis';
            typeSelect.name = 'jenis';
            typeSelect.innerHTML = `<option value='pemasukkan' ${initialJenis === 'pemasukkan' ? 'selected' : ''}>Pemasukkan (Uang Masuk)</option><option value='pengeluaran' ${initialJenis === 'pengeluaran' ? 'selected' : ''}>Pengeluaran (Uang Keluar)</option>`;
            const typeLabel = document.createElement('label');
            typeLabel.htmlFor = 'input-jenis';
            typeLabel.className = 'form-label';
            typeLabel.textContent = 'Jenis Transaksi';
            typeGroup.appendChild(typeLabel);
            typeGroup.appendChild(typeSelect);
            formBody.appendChild(typeGroup);

            const amountGroup = document.createElement('div');
            amountGroup.className = 'mb-3';
            amountGroup.innerHTML = `<label for='input-jumlah' class='form-label'>Nominal (Rp)</label><input type='number' class='form-control form-control-lg' id='input-jumlah' name='jumlah' value='${initialJumlah}' placeholder="0" required min='0'>`;
            formBody.appendChild(amountGroup);
        }

        // --- SUBMIT & ACTIONS ---
        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            let values = [];

            if (currentAction === 'create') {
                if (currentSheet === 'IURAN BULANAN' || currentSheet === 'JADWAL RONDA') {
                    const firstColumnValue = formData.get(currentHeaders[0]) || '';
                    values = [firstColumnValue];
                    for (let i =1; i < currentHeaders.length; i++) {
                        if (currentSheet === 'JADWAL RONDA' && String(currentHeaders[i]).toLowerCase() === 'terakhir ronda') values.push('');
                        else values.push(false);
                    }
                } 
                else if (currentSheet === 'UANG KAS') {
                    const jenis = formData.get('jenis') || '', jumlah = formData.get('jumlah') || '0';
                    const tanggalValue = formData.get('tanggal') || '', keteranganValue = formData.get('keterangan') || '';
                    const formatBulanTahun = (dateString) => {
                        if (!dateString) return '';
                        const date = new Date(dateString);
                        return date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' });
                    };
                    const pemasukkanValue = (jenis === 'pemasukkan') ? jumlah : '0';
                    const pengeluaranValue = (jenis === 'pengeluaran') ? jumlah : '0';
                    values = [formatBulanTahun(tanggalValue), tanggalValue, keteranganValue, pemasukkanValue, pengeluaranValue];
                } 
                else {
                    values = currentHeaders.map(header => {
                        const val = formData.get(header);
                        if (typeof form.elements[`input-${header}`]?.type === 'checkbox') return val === 'on';
                        return val || '';
                    });
                }
            } else {
                values = currentHeaders.map(header => {
                    const val = formData.get(header);
                    if (typeof form.elements[`input-${header}`]?.type === 'checkbox') return val === 'on';
                    return val || '';
                });
            }
            
            showLoader(true);
            let payload = { sheet: currentSheet, action: currentAction, values: values };
            if (currentAction === 'update') payload.row = currentRowNumber;

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                showAlert(`Data berhasil ${currentAction === 'create' ? 'ditambahkan' : 'diperbarui'}!`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
                form.reset();
                loadData(currentSheet);
            } catch (error) {
                showAlert('Terjadi kesalahan: ' + error.message, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function confirmDelete() {
            showLoader(true);
            const payload = { sheet: currentSheet, action: 'delete', row: currentRowNumber };
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                showAlert('Data berhasil dihapus!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                loadData(currentSheet);
            } catch (error) {
                showAlert('Terjadi kesalahan: ' + error.message, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function toggleBoolean(rowNumber, columnName, iconElement) {
            const isCurrentlyTrue = iconElement.classList.contains('bi-check-circle-fill');
            const newValue = !isCurrentlyTrue;
            const originalClasses = iconElement.className;
            const originalTitle = iconElement.title;

            if (newValue) {
                iconElement.className = 'clickable-icon bi bi-check-circle-fill text-success fs-5';
                iconElement.title = 'Selesai. Klik untuk ubah.';
            } else {
                iconElement.className = 'clickable-icon bi bi-circle text-muted fs-5';
                iconElement.title = 'Belum Selesai. Klik untuk ubah.';
            }
            iconElement.classList.add('opacity-50');

            const rowIndex = tableData.findIndex(row => row._row === rowNumber);
            if (rowIndex !== -1) tableData[rowIndex][columnName] = newValue;

            const payload = { sheet: currentSheet, action: 'updateCell', row: rowNumber, column: columnName, value: newValue };
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                showAlert(result.message || 'Status berhasil diperbarui!', 'success');
                if (currentSheet === 'JADWAL RONDA' && newValue === true) {
                    setTimeout(() => loadData(currentSheet), 500);
                }
            } catch (error) {
                showAlert('Gagal memperbarui status: ' + error.message, 'danger');
                iconElement.className = originalClasses;
                iconElement.title = originalTitle;
                if (rowIndex !== -1) tableData[rowIndex][columnName] = isCurrentlyTrue;
            } finally {
                iconElement.classList.remove('opacity-50');
            }
        }

        // --- UTILITIES ---
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow-sm`;
            alertDiv.style.marginBottom = "10px";
            alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
</body>
</html>
