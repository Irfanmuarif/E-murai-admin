<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Admin Dashboard - Spreadsheet API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="min-h-screen flex flex-col md:flex-row">
        <aside class="w-full md:w-64 bg-slate-900 text-white p-6">
            <div class="flex items-center gap-3 mb-10">
                <div class="bg-blue-500 p-2 rounded-lg">
                    <i data-lucide="database" class="w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">SheetAdmin</h1>
            </div>
            <nav class="space-y-2">
                <div class="p-3 bg-blue-600/20 text-blue-400 rounded-lg flex items-center gap-3 border border-blue-600/30">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </div>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-10 overflow-x-hidden">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-900">Database Management</h2>
                    <p class="text-slate-500">Kelola data spreadsheet Anda secara realtime.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openColumnModal()" class="flex items-center gap-2 bg-white border border-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 transition shadow-sm">
                        <i data-lucide="plus-square" class="w-4 h-4 text-slate-600"></i>
                        <span>Tambah Kolom</span>
                    </button>
                    <button onclick="openModal()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Tambah Baris</span>
                    </button>
                </div>
            </header>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div class="relative w-64">
                        <input type="text" id="sheetNameInput" placeholder="Nama Sheet (Contoh: Sheet1)" value="Sheet1" class="w-full pl-10 pr-4 py-2 rounded-md border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition text-sm">
                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 text-slate-400"></i>
                    </div>
                    <button onclick="loadData()" class="text-blue-600 hover:text-blue-700 font-medium text-sm flex items-center gap-1">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Segarkan
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr id="tableHeader" class="bg-slate-50 text-slate-500 uppercase text-xs font-semibold tracking-wider">
                                </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100 text-sm">
                            </tbody>
                    </table>
                </div>
                
                <div id="loadingState" class="hidden p-20 flex flex-col items-center justify-center">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    <p class="text-slate-500 animate-pulse">Menghubungkan ke API...</p>
                </div>
            </div>
        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold">Tambah Data</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition"><i data-lucide="x"></i></button>
            </div>
            <form id="dataForm" class="p-6 space-y-4">
                <input type="hidden" id="editRowNumber">
                <div id="formInputs" class="grid grid-cols-1 gap-4">
                    </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-slate-600 font-medium">Batal</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxULcQjQAV-Lo6QiJwuAcpNL-vJYOtZsyy6JatS7ztrZUEqK5LFvUHUJW0vyNbOmHbV/exec";
        let currentHeaders = [];

        // Initialize Lucide Icons
        lucide.createIcons();

        async function loadData() {
            const sheet = document.getElementById('sheetNameInput').value;
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const loader = document.getElementById('loadingState');

            tableBody.innerHTML = "";
            loader.classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}?sheet=${sheet}`);
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);

                currentHeaders = data.headers;
                
                // Render Headers
                tableHeader.innerHTML = data.headers.map(h => `<th class="px-6 py-4">${h}</th>`).join('') + '<th class="px-6 py-4 text-right">Aksi</th>';
                
                // Render Rows
                tableBody.innerHTML = data.rows.map(row => `
                    <tr class="hover:bg-blue-50/50 transition duration-150">
                        ${data.headers.map(h => `<td class="px-6 py-4 text-slate-600">${row[h] || '-'}</td>`).join('')}
                        <td class="px-6 py-4 text-right space-x-2">
                            <button onclick="editRow(${JSON.stringify(row).replace(/"/g, '&quot;')})" class="p-1.5 text-amber-600 hover:bg-amber-50 rounded-md transition"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="deleteRow(${row._row})" class="p-1.5 text-red-600 hover:bg-red-50 rounded-md transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    </tr>
                `).join('');

                lucide.createIcons();
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- CRUD ACTIONS ---

        document.getElementById('dataForm').onsubmit = async (e) => {
            e.preventDefault();
            const sheet = document.getElementById('sheetNameInput').value;
            const rowNumber = document.getElementById('editRowNumber').value;
            const action = rowNumber ? "update" : "create";
            
            const values = currentHeaders.map(h => document.getElementById(`input-${h}`).value);
            
            const payload = { sheet, action, values };
            if (rowNumber) payload.row = parseInt(rowNumber);

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    loadData();
                }
            } catch (err) { alert("Gagal menyimpan data"); }
        };

        async function deleteRow(rowNumber) {
            if (!confirm("Hapus baris ini?")) return;
            const sheet = document.getElementById('sheetNameInput').value;
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "delete", sheet, row: rowNumber })
                });
                loadData();
            } catch (err) { alert("Gagal menghapus"); }
        }

        async function openColumnModal() {
            const colName = prompt("Masukkan nama kolom baru:");
            if (!colName) return;
            const sheet = document.getElementById('sheetNameInput').value;
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "addColumn", sheet, columnName: colName })
                });
                loadData();
            } catch (err) { alert("Gagal menambah kolom"); }
        }

        // --- UI HELPERS ---

        function openModal(isEdit = false) {
            const formInputs = document.getElementById('formInputs');
            document.getElementById('modalTitle').innerText = isEdit ? "Edit Data" : "Tambah Data";
            
            formInputs.innerHTML = currentHeaders.map(h => `
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">${h}</label>
                    <input type="text" id="input-${h}" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            `).join('');
            
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('editRowNumber').value = "";
            document.getElementById('dataForm').reset();
        }

        function editRow(rowData) {
            openModal(true);
            document.getElementById('editRowNumber').value = rowData._row;
            currentHeaders.forEach(h => {
                document.getElementById(`input-${h}`).value = rowData[h] || "";
            });
        }

        // Initial Load
        loadData();
    </script>
</body>
</html>
